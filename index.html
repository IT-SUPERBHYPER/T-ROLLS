<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reception Stock Inventory</title>
  <style>
    :root {
      --primary-color: #34495e;
      --accent-color: #2ecc71;
      --background-color: #ecf0f1;
      --card-background: #ffffff;
      --text-color: #2c3e50;
      --border-color: #bdc3c7;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
      background: linear-gradient(135deg, #ecf0f1 0%, #dfe6e9 100%);
      color: var(--text-color);
      line-height: 1.6;
    }
    h1 {
      text-align: center;
      font-size: 2.5rem;
      color: var(--primary-color);
      margin-bottom: 40px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    .container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .inventory-section, .stats-section {
      background: var(--card-background);
      padding: 30px;
      margin: 20px 0;
      border-radius: 12px;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }
    .inventory-section:hover, .stats-section:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    h2 {
      font-size: 1.8rem;
      color: var(--primary-color);
      margin-bottom: 20px;
      border-bottom: 2px solid var(--accent-color);
      padding-bottom: 10px;
    }
    h3 {
      font-size: 1.4rem;
      color: var(--primary-color);
      margin-bottom: 10px;
    }
    .item {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    .item label {
      font-weight: 600;
      color: var(--primary-color);
      width: 150px;
      font-size: 1.1rem;
    }
    select, input[type="text"], input[type="number"] {
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 1rem;
      transition: var(--transition);
      background: #f9f9f9;
      width: 200px;
    }
    select:focus, input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.2);
    }
    button {
      padding: 10px 20px;
      background: var(--accent-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
    }
    button:hover {
      background: #27ae60;
      transform: translateY(-2px);
    }
    button:active {
      transform: translateY(0);
    }
    button.reset {
      background: #e74c3c;
    }
    button.reset:hover {
      background: #c0392b;
    }
    .export-buttons {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    .export-buttons button {
      flex: 1;
      background: #3498db;
    }
    .export-buttons button:hover {
      background: #2980b9;
    }
    .current-stocks div {
      font-size: 1.1rem;
      color: var(--text-color);
      margin: 8px 0;
    }
    .stock-highlight {
      background-color: #d4edda;
      transition: background-color 0.5s ease-out;
    }
    #stats {
      margin-top: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: var(--card-background);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }
    th {
      background: var(--primary-color);
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.9rem;
    }
    td {
      background: var(--card-background);
      color: var(--text-color);
    }
    tr:last-child td {
      border-bottom: none;
    }
    .log-entry {
      font-size: 0.95rem;
      color: var(--text-color);
      margin: 8px 0;
      padding: 8px;
      background: #f9f9f9;
      border-radius: 6px;
      border-left: 4px solid var(--accent-color);
    }
    .item-log-container {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 20px;
    }
    .report-section {
      margin-top: 20px;
    }
    .report-summary {
      font-size: 1rem;
      margin-bottom: 5px;
      color: var(--text-color);
    }
    .report-summary-item {
      margin-left: 20px;
      font-size: 0.95rem;
      color: #555;
    }
    .item-log-title {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 10px;
      color: var(--primary-color);
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 5px;
    }
    @media (max-width: 600px) {
      .item {
        flex-direction: column;
        align-items: flex-start;
      }
      select, input[type="text"], input[type="number"] {
        width: 100%;
        margin-bottom: 10px;
      }
      .item label {
        width: 100%;
      }
      .export-buttons {
        flex-direction: column;
      }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <h1>Reception Stock Inventory</h1>
  <div class="container">
    <div class="inventory-section">
      <h2>Inventory Management</h2>
      <div class="item">
        <label for="itemSelect">Select Item:</label>
        <select id="itemSelect">
          <option value="tp">Toilet Paper</option>
          <option value="sw">Saniwipes</option>
          <option value="fap">First Aid Plasters</option>
          <option value="fam">First Aid Masks</option>
          <option value="dhs">Deep Heat Spray</option>
          <option value="fab">First Aid Bandage</option>
        </select>
      </div>
      <div class="item">
        <label for="quantityIn">Add Stock:</label>
        <input type="number" id="quantityIn" min="0" placeholder="Quantity" />
        <input type="text" id="personIn" placeholder="Person's Name" />
        <button id="addBtn">Add</button>
      </div>
      <div class="item">
        <label for="quantityOut">Take Stock:</label>
        <input type="number" id="quantityOut" min="0" placeholder="Quantity" />
        <input type="text" id="personOut" placeholder="Person's Name" />
        <button id="takeBtn">Taken</button>
      </div>
      <div class="item current-stocks">
        <label>Current Stocks:</label>
        <div>Toilet Paper: <span id="tpStock">0</span></div>
        <div>Saniwipes: <span id="swStock">0</span></div>
        <div>First Aid Plasters: <span id="fapStock">0</span></div>
        <div>First Aid Masks: <span id="famStock">0</span></div>
        <div>Deep Heat Spray: <span id="dhsStock">0</span></div>
        <div>First Aid Bandage: <span id="fabStock">0</span></div>
      </div>
    </div>

    <div class="stats-section">
      <h2>Stats Report</h2>
      <button class="reset" id="resetBtn">Reset Stats</button>
      <div class="export-buttons">
        <button id="exportCsvBtn">Export to CSV</button>
        <button id="exportPdfBtn">Export to PDF</button>
      </div>
      <div id="stats"></div>

      <h3>Transaction Log (By Item)</h3>
      <div id="log"></div>

      <div class="report-section">
        <h3>Daily Report</h3>
        <div id="dailyReport"></div>

        <h3>Weekly Report</h3>
        <div id="weeklyReport"></div>

        <h3>Monthly Report</h3>
        <div id="monthlyReport"></div>
      </div>
    </div>
  </div>

  <script>
    // JSON Bin API Configuration
    const JSON_BIN_API_URL = 'https://api.jsonbin.io/v3/b/68872a55ae596e708fbcdef8';
    const JSON_BIN_API_KEY = '$2a$10$BqM/s2f2kqZGoB5V14WtWOPOVO5/ccx/wZtBqmQsgeQqh6WMp42We';
    const RESET_PASSWORD = 'Superb@123';

    // Inventory items
    let items = {
      tp: { name: 'Toilet Paper', stock: 0, in: 0, out: 0 },
      sw: { name: 'Saniwipes', stock: 0, in: 0, out: 0 },
      fap: { name: 'First Aid Plasters', stock: 0, in: 0, out: 0 },
      fam: { name: 'First Aid Masks', stock: 0, in: 0, out: 0 },
      dhs: { name: 'Deep Heat Spray', stock: 0, in: 0, out: 0 },
      fab: { name: 'First Aid Bandage', stock: 0, in: 0, out: 0 }
    };

    let transactionLog = [];

    const stockDisplayIds = {
      tp: 'tpStock',
      sw: 'swStock',
      fap: 'fapStock',
      fam: 'famStock',
      dhs: 'dhsStock',
      fab: 'fabStock'
    };

    function loadData() {
      fetch(JSON_BIN_API_URL, {
        method: 'GET',
        headers: { 'X-Master-Key': JSON_BIN_API_KEY }
      })
      .then(response => {
        if (!response.ok) {
          if (response.status === 404) {
            console.warn('JSON Bin not found. Initializing defaults.');
            initializeDefaults();
            return null;
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data && data.record) {
          Object.keys(data.record.inventory).forEach(key => {
            if (items[key]) items[key] = data.record.inventory[key];
            else items[key] = data.record.inventory[key];
          });
          Object.keys(items).forEach(key => {
            if (!data.record.inventory[key]) {
              items[key] = { name: items[key].name, stock: 0, in: 0, out: 0 };
            }
          });
          transactionLog = Array.isArray(data.record.transactionLog) ? data.record.transactionLog : [];
        } else {
          initializeDefaults();
        }
      })
      .catch(error => {
        console.error('Load error:', error);
        alert('Cloud load failed. Loading from local storage or defaults.');
        const saved = localStorage.getItem('inventory');
        if (saved) {
          try {
            const parsed = JSON.parse(saved);
            Object.keys(items).forEach(key => {
              if (parsed[key]) items[key] = parsed[key];
            });
          } catch (e) { console.error('Parse inventory error:', e); }
        }
        const savedLog = localStorage.getItem('transactionLog');
        if (savedLog) {
          try {
            const parsed = JSON.parse(savedLog);
            if (Array.isArray(parsed) && typeof parsed[0] === 'string') {
              transactionLog = parseLegacyLog(parsed);
            } else {
              transactionLog = parsed;
            }
          } catch (e) { console.error('Parse log error:', e); }
        }
        if (!saved && !savedLog && transactionLog.length === 0) {
          initializeDefaults();
        }
      })
      .finally(() => {
        updateDisplay();
        updateStats();
        updateLog();
        generateReports();
      });
    }

    function parseLegacyLog(entries) {
      return entries.map(entry => {
        const match = entry.match(/\[(\d{2}\/\d{2}\/\d{4}), (\d{2}:\d{2}:\d{2})\] (Added|Taken) (\d+) of (.*) by (.*)\./);
        if (!match) return null;
        const [day, month, year] = match[1].split('/').map(Number);
        const [h, m, s] = match[2].split(':').map(Number);
        const date = new Date(year, month - 1, day, h, m, s);
        let itemKey = '';
        Object.keys(items).forEach(k => {
          if (items[k].name === match[5]) itemKey = k;
        });
        return {
          timestamp: date.toISOString(),
          type: match[3].toLowerCase() === 'added' ? 'add' : 'take',
          itemKey,
          quantity: Number(match[4]),
          person: match[6]
        };
      }).filter(Boolean);
    }

    function saveData() {
      const dataToSave = { inventory: items, transactionLog };
      fetch(JSON_BIN_API_URL, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Master-Key': JSON_BIN_API_KEY,
          'X-Bin-Meta': 'false'
        },
        body: JSON.stringify(dataToSave)
      })
      .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
      })
      .then(() => console.log('Saved to JSON Bin.'))
      .catch(error => {
        console.error('Save error:', error);
        alert('Save failed. Saved to local storage.');
        localStorage.setItem('inventory', JSON.stringify(items));
        localStorage.setItem('transactionLog', JSON.stringify(transactionLog));
      });
    }

    function initializeDefaults() {
      items = {
        tp: { name: 'Toilet Paper', stock: 6, in: 205, out: 199 },
        sw: { name: 'Saniwipes', stock: 7, in: 12, out: 5 },
        fap: { name: 'First Aid Plasters', stock: 91, in: 103, out: 12 },
        fam: { name: 'First Aid Masks', stock: 95, in: 98, out: 3 },
        dhs: { name: 'Deep Heat Spray', stock: 0, in: 0, out: 0 },
        fab: { name: 'First Aid Bandage', stock: 0, in: 0, out: 0 }
      };
      transactionLog = [
        { timestamp: "2025-07-27T09:50:08.000Z", type: "take", itemKey: "tp", quantity: 12, person: "Jabu" },
        { timestamp: "2025-07-27T08:07:41.000Z", type: "take", itemKey: "tp", quantity: 12, person: "Bongiwe" },
        { timestamp: "2025-07-27T07:56:10.000Z", type: "take", itemKey: "fap", quantity: 2, person: "Noxolom" },
        { timestamp: "2025-07-26T15:07:50.000Z", type: "take", itemKey: "sw", quantity: 1, person: "Khanyisile" },
        { timestamp: "2025-07-26T12:54:21.000Z", type: "take", itemKey: "fap", quantity: 2, person: "MM2" },
        { timestamp: "2025-07-26T12:26:43.000Z", type: "take", itemKey: "fap", quantity: 2, person: "MM2" },
        { timestamp: "2025-07-26T12:26:22.000Z", type: "take", itemKey: "tp", quantity: 6, person: "Bongiwe" },
        { timestamp: "2025-07-26T08:34:59.000Z", type: "take", itemKey: "fam", quantity: 1, person: "PnS merchandiser" },
        { timestamp: "2025-07-26T08:13:14.000Z", type: "take", itemKey: "tp", quantity: 12, person: "Bongiwe" },
        { timestamp: "2025-07-26T07:46:48.000Z", type: "take", itemKey: "tp", quantity: 6, person: "Abigail" }
      ];
    }

    function updateDisplay() {
      Object.keys(items).forEach(key => {
        const el = document.getElementById(stockDisplayIds[key]);
        if (el) el.textContent = items[key].stock;
      });
    }

    function updateStats() {
      let html = '<table><thead><tr><th>Item</th><th>Current Stock</th><th>Total In</th><th>Total Out</th></tr></thead><tbody>';
      Object.values(items).forEach(item => {
        html += `<tr><td>${item.name}</td><td>${item.stock}</td><td>${item.in}</td><td>${item.out}</td></tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('stats').innerHTML = html;
    }

    function updateLog() {
      const logDiv = document.getElementById('log');
      let html = '';

      Object.keys(items).forEach(key => {
        const item = items[key];
        const logs = transactionLog.filter(e => e.itemKey === key && e.type !== 'reset');
        if (logs.length > 0) {
          html += `<div class="item-log-title">${item.name}</div><div class="item-log-container">`;
          [...logs].reverse().forEach(e => {
            const date = new Date(e.timestamp);
            const fDate = date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const fTime = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const action = e.type === 'add' ? 'Added' : 'Taken';
            html += `<div class="log-entry">[${fDate}, ${fTime}] ${action} ${e.quantity} by ${e.person}.</div>`;
          });
          html += '</div>';
        }
      });

      const resets = transactionLog.filter(e => e.type === 'reset');
      if (resets.length > 0) {
        html += `<div class="item-log-title">System Resets</div><div class="item-log-container">`;
        [...resets].reverse().forEach(e => {
          const date = new Date(e.timestamp);
          const fDate = date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
          const fTime = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
          html += `<div class="log-entry">[${fDate}, ${fTime}] Stats reset by ${e.person}.</div>`;
        });
        html += '</div>';
      }

      logDiv.innerHTML = html || '<p>No transactions yet.</p>';
    }

    function applyHighlight(itemKey) {
      const el = document.getElementById(stockDisplayIds[itemKey]);
      if (el) {
        el.classList.add('stock-highlight');
        setTimeout(() => el.classList.remove('stock-highlight'), 1000);
      }
    }

    function addStock() {
      const itemKey = document.getElementById('itemSelect').value;
      const qty = Number(document.getElementById('quantityIn').value);
      const person = document.getElementById('personIn').value.trim();

      if (!qty || qty <= 0) return alert('Enter a positive quantity.');
      if (!person) return alert('Enter person’s name.');

      items[itemKey].stock += qty;
      items[itemKey].in += qty;
      transactionLog.push({
        timestamp: new Date().toISOString(),
        type: 'add',
        itemKey,
        quantity: qty,
        person
      });

      saveData();
      updateDisplay();
      updateStats();
      updateLog();
      generateReports();
      applyHighlight(itemKey);
      document.getElementById('quantityIn').value = '';
      document.getElementById('personIn').value = '';
    }

    function takeStock() {
      const itemKey = document.getElementById('itemSelect').value;
      const qty = Number(document.getElementById('quantityOut').value);
      const person = document.getElementById('personOut').value.trim();

      if (!qty || qty <= 0) return alert('Enter a positive quantity.');
      if (!person) return alert('Enter person’s name.');
      if (items[itemKey].stock < qty) return alert(`Not enough ${items[itemKey].name}.`);

      items[itemKey].stock -= qty;
      items[itemKey].out += qty;
      transactionLog.push({
        timestamp: new Date().toISOString(),
        type: 'take',
        itemKey,
        quantity: qty,
        person
      });

      saveData();
      updateDisplay();
      updateStats();
      updateLog();
      generateReports();
      applyHighlight(itemKey);
      document.getElementById('quantityOut').value = '';
      document.getElementById('personOut').value = '';
    }

    function resetStats() {
      const password = prompt('Enter password to reset:');
      if (password === null) return;
      if (password !== RESET_PASSWORD) return alert('Incorrect password.');
      if (!confirm('Reset all stats? This cannot be undone.')) return;

      Object.keys(items).forEach(key => {
        items[key].stock = 0;
        items[key].in = 0;
        items[key].out = 0;
      });
      transactionLog = [{
        timestamp: new Date().toISOString(),
        type: 'reset',
        itemKey: 'all',
        quantity: 0,
        person: 'User (Password Reset)'
      }];

      saveData();
      updateDisplay();
      updateStats();
      updateLog();
      generateReports();
    }

    function generateReports() {
      updateDailyReport();
      updateWeeklyReport();
      updateMonthlyReport();
    }

    function getAggregatedReport(filteredLogs) {
      const reportData = {};
      let totalIn = 0;
      let totalOut = 0;

      Object.keys(items).forEach(key => {
        reportData[key] = { in: 0, out: 0 };
      });

      filteredLogs.forEach(entry => {
        if (entry.type === 'reset') return;
        const key = entry.itemKey;
        if (!reportData[key]) return;

        if (entry.type === 'add') {
          reportData[key].in += entry.quantity;
          totalIn += entry.quantity;
        } else if (entry.type === 'take') {
          reportData[key].out += entry.quantity;
          totalOut += entry.quantity;
        }
      });

      let html = '';
      if (totalIn > 0 || totalOut > 0) {
        html += `<div class="report-summary">Total Added: ${totalIn}</div>`;
        html += `<div class="report-summary">Total Taken: ${totalOut}</div>`;
        Object.keys(items).forEach(key => {
          const item = items[key];
          const inQty = reportData[key].in;
          const outQty = reportData[key].out;
          if (inQty > 0 || outQty > 0) {
            html += `<div class="report-summary-item">${item.name}: Added ${inQty}, Taken ${outQty}</div>`;
          }
        });
      } else {
        html = '<p>No transactions for this period.</p>';
      }

      return html;
    }

    function updateDailyReport() {
      const now = new Date();
      const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 0, 0, 0));
      const end = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 23, 59, 59));
      const logs = transactionLog.filter(e => {
        const d = new Date(e.timestamp);
        return d >= start && d <= end;
      });
      document.getElementById('dailyReport').innerHTML = getAggregatedReport(logs);
    }

    function updateWeeklyReport() {
      const now = new Date();
      const day = now.getUTCDay();
      const diff = now.getUTCDate() - day;
      const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), diff, 0, 0, 0));
      const end = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), diff + 6, 23, 59, 59));
      const logs = transactionLog.filter(e => {
        const d = new Date(e.timestamp);
        return d >= start && d <= end;
      });
      document.getElementById('weeklyReport').innerHTML = getAggregatedReport(logs);
    }

    function updateMonthlyReport() {
      const now = new Date();
      const year = now.getUTCFullYear();
      const month = now.getUTCMonth();
      const start = new Date(Date.UTC(year, month, 1, 0, 0, 0));
      const end = new Date(Date.UTC(year, month + 1, 0, 23, 59, 59));
      const logs = transactionLog.filter(e => {
        const d = new Date(e.timestamp);
        return d >= start && d <= end;
      });
      document.getElementById('monthlyReport').innerHTML = getAggregatedReport(logs);
    }

    function exportToCsv() {
      const reportType = prompt("Export: 'month' for Month-to-Date, 'year' for Year-to-Date, 'life' for all.").toLowerCase();
      const now = new Date();
      const todayEnd = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 23, 59, 59));
      let filtered = [];

      if (reportType === 'month') {
        const first = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1));
        filtered = transactionLog.filter(e => new Date(e.timestamp) >= first && new Date(e.timestamp) <= todayEnd && e.type !== 'reset');
      } else if (reportType === 'year') {
        const first = new Date(Date.UTC(now.getUTCFullYear(), 0, 1));
        filtered = transactionLog.filter(e => new Date(e.timestamp) >= first && new Date(e.timestamp) <= todayEnd && e.type !== 'reset');
      } else {
        filtered = transactionLog.filter(e => e.type !== 'reset');
      }

      let csv = "data:text/csv;charset=utf-8,Item,Current Stock,Total In,Total Out\n";
      Object.values(items).forEach(i => csv += `${i.name},${i.stock},${i.in},${i.out}\n`);
      csv += "\n\nTimestamp,Action,Item,Quantity,Person\n";
      [...filtered].reverse().forEach(e => {
        const d = new Date(e.timestamp).toLocaleString('en-GB');
        const a = e.type === 'add' ? 'Added' : 'Taken';
        const n = items[e.itemKey]?.name || e.itemKey;
        csv += `"${d}","${a}","${n}",${e.quantity},"${e.person}"\n`;
      });

      const link = document.createElement("a");
      link.href = encodeURI(csv);
      link.download = `inventory_report_${reportType}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function exportToPdf() {
      if (typeof window.jspdf === 'undefined') return alert("jsPDF not loaded.");
      const { jsPDF } = window.jspdf;
      if (typeof jsPDF().autoTable === 'undefined') return alert("AutoTable plugin not loaded.");

      const reportType = prompt("Report: 'month' for MTD, 'year' for YTD, 'life' for all.").toLowerCase();
      const now = new Date();
      const todayEnd = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 23, 59, 59));
      let filteredTransactions = [];
      let reportTitle = "Reception Stock Inventory Report (Life to Date)";

      if (reportType === 'month') {
        reportTitle = "Reception Stock Inventory Report (Month to Date)";
        const first = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1));
        filteredTransactions = transactionLog.filter(e => {
          const d = new Date(e.timestamp);
          return d >= first && d <= todayEnd && e.type !== 'reset';
        });
      } else if (reportType === 'year') {
        reportTitle = "Reception Stock Inventory Report (Year to Date)";
        const first = new Date(Date.UTC(now.getUTCFullYear(), 0, 1));
        filteredTransactions = transactionLog.filter(e => {
          const d = new Date(e.timestamp);
          return d >= first && d <= todayEnd && e.type !== 'reset';
        });
      } else {
        filteredTransactions = transactionLog.filter(e => e.type !== 'reset');
      }

      const doc = new jsPDF();
      doc.setFontSize(18);
      doc.text(reportTitle, 10, 10);

      doc.setFontSize(14);
      doc.text("Current Stock Levels:", 10, 25);

      const stockData = Object.values(items).map(i => [i.name, i.stock, i.in, i.out]);
      doc.autoTable({
        startY: 30,
        head: [['Item', 'Current Stock', 'Total In', 'Total Out']],
        body: stockData,
        theme: 'grid',
        styles: { fontSize: 10 },
        columnStyles: { 0: { cellWidth: 40 }, 1: { cellWidth: 30 }, 2: { cellWidth: 30 }, 3: { cellWidth: 30 } }
      });

      const logY = doc.autoTable.previous.finalY + 10;
      doc.setFontSize(14);
      doc.text("Transaction Log:", 10, logY);

      const logData = [...filteredTransactions].reverse().map(e => {
        const d = new Date(e.timestamp).toLocaleString('en-GB');
        const a = e.type === 'add' ? 'Added' : 'Taken';
        const n = items[e.itemKey]?.name || e.itemKey;
        return [d, `${a} ${e.quantity} of ${n} by ${e.person}.`];
      });

      if (logData.length > 0) {
        doc.autoTable({
          startY: logY + 5,
          head: [['Timestamp', 'Description']],
          body: logData,
          theme: 'grid',
          styles: { fontSize: 8 },
          columnStyles: { 0: { cellWidth: 50 }, 1: { cellWidth: 'auto' } }
        });
      } else {
        doc.text("No transactions for this period.", 10, logY + 10);
      }

      doc.save(`inventory_report_${reportType}.pdf`);
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      document.getElementById('addBtn').addEventListener('click', addStock);
      document.getElementById('takeBtn').addEventListener('click', takeStock);
      document.getElementById('resetBtn').addEventListener('click', resetStats);
      document.getElementById('exportCsvBtn').addEventListener('click', exportToCsv);
      document.getElementById('exportPdfBtn').addEventListener('click', exportToPdf);
    });
  </script>
</body>
</html>