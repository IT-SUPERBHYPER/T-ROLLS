
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reception Stock Inventory</title>
<style>
  :root {
    --primary-color: #34495e;
    --accent-color: #2ecc71;
    --background-color: #ecf0f1;
    --card-background: #ffffff;
    --text-color: #2c3e50;
    --border-color: #bdc3c7;
    --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    --transition: all 0.3s ease;
  }
  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 20px;
    background: linear-gradient(135deg, #ecf0f1 0%, #dfe6e9 100%);
    color: var(--text-color);
    line-height: 1.6;
  }
  h1 {
    text-align: center;
    font-size: 2.5rem;
    color: var(--primary-color);
    margin-bottom: 40px;
    text-transform: uppercase;
    letter-spacing: 2px;
  }
  .container {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  .inventory-section, .stats-section {
    background: var(--card-background);
    padding: 30px;
    margin: 20px 0;
    border-radius: 12px;
    box-shadow: var(--shadow);
    transition: var(--transition);
  }
  .inventory-section:hover, .stats-section:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
  }
  h2 {
    font-size: 1.8rem;
    color: var(--primary-color);
    margin-bottom: 20px;
    border-bottom: 2px solid var(--accent-color);
    padding-bottom: 10px;
  }
  h3, h4 {
    font-size: 1.4rem;
    color: var(--primary-color);
    margin-bottom: 10px;
  }
  .item {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
  }
  .item label {
    font-weight: 600;
    color: var(--primary-color);
    width: 150px;
    font-size: 1.1rem;
  }
  select, input[type="text"], input[type="number"] {
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 1rem;
    transition: var(--transition);
    background: #f9f9f9;
    width: 200px;
  }
  select:focus, input:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.2);
  }
  button {
    padding: 10px 20px;
    background: var(--accent-color);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    transition: var(--transition);
  }
  button:hover {
    background: #27ae60;
    transform: translateY(-2px);
  }
  button:active {
    transform: translateY(0);
  }
  button.reset {
    background: #e74c3c;
  }
  button.reset:hover {
    background: #c0392b;
  }
  .export-buttons {
    margin-top: 20px;
    display: flex;
    gap: 10px;
  }
  .export-buttons button {
    flex: 1;
    background: #3498db;
  }
  .export-buttons button:hover {
    background: #2980b9;
  }
  .current-stocks div {
    font-size: 1.1rem;
    color: var(--text-color);
    margin: 8px 0;
  }
  .stock-highlight {
    background-color: #d4edda;
    transition: background-color 0.5s ease-out;
  }
  #stats {
    margin-top: 20px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    background: var(--card-background);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: var(--shadow);
  }
  th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
  }
  th {
    background: var(--primary-color);
    color: white;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.9rem;
  }
  td {
    background: var(--card-background);
    color: var(--text-color);
  }
  tr:last-child td {
    border-bottom: none;
  }
  .log-entry {
    font-size: 0.95rem;
    color: var(--text-color);
    margin: 8px 0;
    padding: 8px;
    background: #f9f9f9;
    border-radius: 6px;
    border-left: 4px solid var(--accent-color);
  }
  .item-log-container {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 20px;
  }
  .report-section {
    margin-top: 20px;
  }
  .report-summary {
    font-size: 1rem;
    margin-bottom: 5px;
    color: var(--text-color);
  }
  .report-summary-item {
    margin-left: 20px;
    font-size: 0.95rem;
    color: #555;
  }
  .item-log-title {
    font-size: 1.2rem;
    font-weight: bold;
    margin-bottom: 10px;
    color: var(--primary-color);
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 5px;
  }
  @media (max-width: 600px) {
    .item {
      flex-direction: column;
      align-items: flex-start;
    }
    select, input[type="text"], input[type="number"] {
      width: 100%;
      margin-bottom: 10px;
    }
    .item label {
      width: 100%;
    }
    .export-buttons {
      flex-direction: column;
    }
  }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
<h1>Reception Stock Inventory</h1>
<div class="container">
  <div class="inventory-section">
    <h2>Inventory Management</h2>
    <div class="item">
      <label for="itemSelect">Select Item:</label>
      <select id="itemSelect">
        <option value="tp">Toilet Paper</option>
        <option value="sw">Saniwipes</option>
        <option value="fap">First Aid Plasters</option>
        <option value="fam">First Aid Masks</option>
        <option value="dhs">Deep Heat Spray</option>
        <option value="fab">First Aid Bandage</option>
      </select>
    </div>
    <div class="item">
      <label for="quantityIn">Add Stock:</label>
      <input type="number" id="quantityIn" min="0" placeholder="Quantity" />
      <input type="text" id="personIn" placeholder="Person's Name" />
      <button id="addBtn">Add</button>
    </div>
    <div class="item">
      <label for="quantityOut">Take Stock:</label>
      <input type="number" id="quantityOut" min="0" placeholder="Quantity" />
      <input type="text" id="personOut" placeholder="Person's Name" />

      <!-- Dropdown for Toilet Paper Purpose -->
      <div id="toiletPurposeContainer" style="display: none; width: 200px;">
        <select id="toiletPurpose">
          <option value="">Select Purpose</option>
          <option value="Prayer">Prayer</option>
          <option value="Customer">Customer</option>
          <option value="Team Members">Team Members</option>
          <option value="Main Office">Main Office</option>
        </select>
      </div>

      <button id="takeBtn">Taken</button>
    </div>
    <div class="item current-stocks">
      <label>Current Stocks:</label>
      <div>Toilet Paper: <span id="tpStock">0</span></div>
      <div>Saniwipes: <span id="swStock">0</span></div>
      <div>First Aid Plasters: <span id="fapStock">0</span></div>
      <div>First Aid Masks: <span id="famStock">0</span></div>
      <div>Deep Heat Spray: <span id="dhsStock">0</span></div>
      <div>First Aid Bandage: <span id="fabStock">0</span></div>
    </div>
  </div>
  <div class="stats-section">
    <h2>Stats Report</h2>
    <button class="reset" id="resetBtn">Reset Stats</button>
    <div class="export-buttons">
      <button id="exportCsvBtn">Export to CSV</button>
      <button id="exportPdfBtn">Export to PDF</button>
    </div>
    <div id="stats"></div>
    <h3>Transaction Log (By Item)</h3>
    <div id="log"></div>
    <div class="report-section">
      <h3>Daily Report</h3>
      <div id="dailyReport"></div>
      <h3>Weekly Report</h3>
      <div id="weeklyReport"></div>
      <h3>Monthly Report</h3>
      <div id="currentMonthReport"></div>
      <div id="lastMonthReport"></div>
    </div>
  </div>
</div>
<script>
  // JSON Bin API Configuration
  const JSON_BIN_API_URL = 'https://api.jsonbin.io/v3/b/68872a55ae596e708fbcdef8';
  const JSON_BIN_API_KEY = '$2a$10$BqM/s2f2kqZGoB5V14WtWOPOVO5/ccx/wZtBqmQsgeQqh6WMp42We';
  const RESET_PASSWORD = 'Superb@123';

  // Inventory items with initial values
  let items = {
    tp: { name: 'Toilet Paper', stock: 0, in: 0, out: 0 },
    sw: { name: 'Saniwipes', stock: 0, in: 0, out: 0 },
    fap: { name: 'First Aid Plasters', stock: 0, in: 0, out: 0 },
    fam: { name: 'First Aid Masks', stock: 0, in: 0, out: 0 },
    dhs: { name: 'Deep Heat Spray', stock: 0, in: 0, out: 0 },
    fab: { name: 'First Aid Bandage', stock: 0, in: 0, out: 0 }
  };
  let transactionLog = [];

  // Map item keys to their respective stock display IDs
  const stockDisplayIds = {
    tp: 'tpStock',
    sw: 'swStock',
    fap: 'fapStock',
    fam: 'famStock',
    dhs: 'dhsStock',
    fab: 'fabStock'
  };

  // Load data from JSON Bin
  function loadData() {
    fetch(JSON_BIN_API_URL, {
        method: 'GET',
        headers: {
            'X-Master-Key': JSON_BIN_API_KEY
        }
    })
    .then(response => {
        if (!response.ok) {
            if (response.status === 404) {
                console.warn('JSON Bin not found (404), initializing defaults.');
                initializeDefaults();
                return null;
            }
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data && data.record) {
            for (const key in data.record.inventory) {
                if (items[key]) {
                    items[key] = data.record.inventory[key];
                } else {
                    items[key] = data.record.inventory[key];
                }
            }
            for (const key in items) {
                if (!data.record.inventory[key]) {
                    items[key] = { ...items[key] };
                }
            }
            transactionLog = Array.isArray(data.record.transactionLog) ? data.record.transactionLog : [];
            console.log('Data loaded from JSON bin.');
        } else {
            console.log("No valid data fetched. Using defaults.");
            initializeDefaults();
        }
    })
    .catch(error => {
        console.error('Error loading from JSON bin:', error);
        alert('Cloud load failed. Loading from local storage or defaults.');
        const saved = localStorage.getItem('inventory');
        if (saved) {
            try {
                const savedItems = JSON.parse(saved);
                for (const key in items) {
                    if (savedItems[key]) items[key] = savedItems[key];
                }
                for (const key in savedItems) {
                    if (!items[key]) items[key] = savedItems[key];
                }
            } catch (e) {
                console.error('Error parsing inventory from localStorage:', e);
            }
        }
        const savedLog = localStorage.getItem('transactionLog');
        if (savedLog) {
            try {
                const parsedLog = JSON.parse(savedLog);
                if (Array.isArray(parsedLog) && parsedLog.length > 0 && typeof parsedLog[0] === 'string') {
                    transactionLog = parsedLog.map(entry => {
                        const match = entry.match(/\[(\d{2}\/\d{2}\/\d{4}), (\d{2}:\d{2}:\d{2})\] (Added|Taken) (\d+) of (.*) by (.*)\./);
                        if (match) {
                            const [day, month, year] = match[1].split('/').map(Number);
                            const [hours, minutes, seconds] = match[2].split(':').map(Number);
                            const date = new Date(year, month - 1, day, hours, minutes, seconds);
                            let itemKey = '';
                            for (const key in items) {
                                if (items[key].name === match[5]) {
                                    itemKey = key;
                                    break;
                                }
                            }
                            return {
                                timestamp: date.toISOString(),
                                type: match[3].toLowerCase() === 'added' ? 'add' : 'take',
                                itemKey,
                                quantity: Number(match[4]),
                                person: match[6]
                            };
                        }
                        return null;
                    }).filter(entry => entry !== null);
                } else {
                    transactionLog = Array.isArray(parsedLog) ? parsedLog : [];
                }
            } catch (e) {
                console.error('Error parsing transactionLog from localStorage:', e);
                transactionLog = [];
            }
        }
        if (!saved && !savedLog && transactionLog.length === 0) {
            initializeDefaults();
        }
    })
    .finally(() => {
        updateDisplay();
        updateStats();
        updateLog();
        generateReports();
        updateToiletPurposeVisibility(); // Ensure correct visibility on load
    });
  }

  function saveData() {
    const dataToSave = { inventory: items, transactionLog };
    fetch(JSON_BIN_API_URL, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-Master-Key': JSON_BIN_API_KEY,
            'X-Bin-Meta': 'false'
        },
        body: JSON.stringify(dataToSave)
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(data => console.log('Saved to JSON bin:', data))
    .catch(error => {
        console.error('Save failed:', error);
        alert('Cloud save failed. Saved to local storage.');
        localStorage.setItem('inventory', JSON.stringify(items));
        localStorage.setItem('transactionLog', JSON.stringify(transactionLog));
    });
  }

  function initializeDefaults() {
    items = {
      tp: { name: 'Toilet Paper', stock: 6, in: 205, out: 199 },
      sw: { name: 'Saniwipes', stock: 7, in: 12, out: 5 },
      fap: { name: 'First Aid Plasters', stock: 91, in: 103, out: 12 },
      fam: { name: 'First Aid Masks', stock: 95, in: 98, out: 3 },
      dhs: { name: 'Deep Heat Spray', stock: 0, in: 0, out: 0 },
      fab: { name: 'First Aid Bandage', stock: 0, in: 0, out: 0 }
    };
    transactionLog = [
      { timestamp: "2025-07-27T09:50:08.000Z", type: "take", itemKey: "tp", quantity: 12, person: "Jabu", purpose: "Customer" },
      { timestamp: "2025-07-27T08:07:41.000Z", type: "take", itemKey: "tp", quantity: 12, person: "Bongiwe", purpose: "Team Members" },
      { timestamp: "2025-07-27T07:56:10.000Z", type: "take", itemKey: "fap", quantity: 2, person: "Noxolom" },
      { timestamp: "2025-07-26T15:07:50.000Z", type: "take", itemKey: "sw", quantity: 1, person: "Khanyisile" },
      { timestamp: "2025-07-26T12:54:21.000Z", type: "take", itemKey: "fap", quantity: 2, person: "MM2" },
      { timestamp: "2025-07-26T12:26:43.000Z", type: "take", itemKey: "fap", quantity: 2, person: "MM2" },
      { timestamp: "2025-07-26T12:26:22.000Z", type: "take", itemKey: "tp", quantity: 6, person: "Bongiwe", purpose: "Prayer" },
      { timestamp: "2025-07-26T08:34:59.000Z", type: "take", itemKey: "fam", quantity: 1, person: "PnS merchandiser" },
      { timestamp: "2025-07-26T08:13:14.000Z", type: "take", itemKey: "tp", quantity: 12, person: "Bongiwe", purpose: "Main Office" },
      { timestamp: "2025-07-26T07:46:48.000Z", type: "take", itemKey: "tp", quantity: 6, person: "Abigail", purpose: "Customer" }
    ];
  }

  function updateDisplay() {
    for (const key in items) {
      const element = document.getElementById(stockDisplayIds[key]);
      if (element) element.textContent = items[key].stock;
    }
  }

  function updateStats() {
    let html = '<table><thead><tr><th>Item</th><th>Current Stock</th><th>Total In</th><th>Total Out</th></tr></thead><tbody>';
    for (const key in items) {
      const item = items[key];
      html += `<tr><td>${item.name}</td><td>${item.stock}</td><td>${item.in}</td><td>${item.out}</td></tr>`;
    }
    html += '</tbody></table>';
    document.getElementById('stats').innerHTML = html;
  }

  function updateLog() {
    const logDiv = document.getElementById('log');
    if (transactionLog.length === 0) {
      logDiv.innerHTML = '<p>No transactions yet.</p>';
      return;
    }
    let html = '';
    for (const key in items) {
      const item = items[key];
      const itemLogs = transactionLog.filter(entry => entry.itemKey === key && entry.type !== 'reset');
      if (itemLogs.length > 0) {
        html += `<div class="item-log-title">${item.name} Transactions</div>`;
        html += '<div class="item-log-container">';
        const reversedLogs = [...itemLogs].reverse();
        for (const entry of reversedLogs) {
          const date = new Date(entry.timestamp);
          const formattedDate = date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
          const formattedTime = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
          let logText = `[${formattedDate}, ${formattedTime}] ${entry.type === 'add' ? 'Added' : 'Taken'} ${entry.quantity} of ${item.name} by ${entry.person}`;
          if (entry.itemKey === 'tp' && entry.purpose) {
            logText += ` for ${entry.purpose}`;
          }
          logText += '.';
          html += `<div class="log-entry">${logText}</div>`;
        }
        html += '</div>';
      }
    }
    const resetEntries = transactionLog.filter(entry => entry.type === 'reset');
    if (resetEntries.length > 0) {
      html += '<div class="item-log-title">System Resets</div>';
      html += '<div class="item-log-container">';
      const reversedResets = [...resetEntries].reverse();
      for (const entry of reversedResets) {
        const date = new Date(entry.timestamp);
        const formattedDate = date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const formattedTime = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        html += `<div class="log-entry">[${formattedDate}, ${formattedTime}] Stats and stock reset by ${entry.person}.</div>`;
      }
      html += '</div>';
    }
    logDiv.innerHTML = html;
  }

  function applyHighlight(itemKey) {
    const stockElement = document.getElementById(stockDisplayIds[itemKey]);
    if (stockElement) {
      stockElement.classList.add('stock-highlight');
      setTimeout(() => stockElement.classList.remove('stock-highlight'), 1000);
    }
  }

  function addStock() {
    const itemKey = document.getElementById('itemSelect').value;
    const qty = Number(document.getElementById('quantityIn').value);
    const person = document.getElementById('personIn').value.trim();
    if (!qty || qty <= 0) return alert('Please enter a positive quantity to add.');
    if (!person) return alert('Please enter the person\'s name.');
    items[itemKey].stock += qty;
    items[itemKey].in += qty;
    transactionLog.push({
      timestamp: new Date().toISOString(),
      type: "add",
      itemKey,
      quantity: qty,
      person
    });
    saveData();
    updateDisplay();
    updateStats();
    updateLog();
    generateReports();
    applyHighlight(itemKey);
    document.getElementById('quantityIn').value = '';
    document.getElementById('personIn').value = '';
  }

  function takeStock() {
    const itemKey = document.getElementById('itemSelect').value;
    const qty = Number(document.getElementById('quantityOut').value);
    const person = document.getElementById('personOut').value.trim();

    if (!qty || qty <= 0) return alert('Please enter a positive quantity to take.');
    if (!person) return alert('Please enter the person\'s name.');

    if (items[itemKey].stock < qty) {
      return alert(`Not enough stock of ${items[itemKey].name}. Current stock: ${items[itemKey].stock}`);
    }

    let purpose = '';
    if (itemKey === 'tp') {
      purpose = document.getElementById('toiletPurpose').value;
      if (!purpose) return alert('Please select a purpose for taking toilet paper.');
    }

    items[itemKey].stock -= qty;
    items[itemKey].out += qty;

    const transaction = {
      timestamp: new Date().toISOString(),
      type: "take",
      itemKey,
      quantity: qty,
      person
    };

    if (itemKey === 'tp') {
      transaction.purpose = purpose;
    }

    transactionLog.push(transaction);

    saveData();
    updateDisplay();
    updateStats();
    updateLog();
    generateReports();
    applyHighlight(itemKey);

    document.getElementById('quantityOut').value = '';
    document.getElementById('personOut').value = '';
    if (itemKey === 'tp') {
      document.getElementById('toiletPurpose').value = '';
    }
  }

  function resetStats() {
    const password = prompt('Please enter the password to reset stats:');
    if (password === null) return;
    if (password !== RESET_PASSWORD) return alert('Incorrect password. Reset cancelled.');
    if (!confirm('Are you sure you want to reset all stats and logs? This cannot be undone.')) return;

    for (const key in items) {
      items[key].stock = 0;
      items[key].in = 0;
      items[key].out = 0;
    }
    transactionLog = [{
      timestamp: new Date().toISOString(),
      type: "reset",
      itemKey: "all",
      quantity: 0,
      person: "User (Password Reset)"
    }];
    saveData();
    updateDisplay();
    updateStats();
    updateLog();
    generateReports();
  }

  function getAggregatedReport(filteredLogs) {
    const reportData = {};
    for (const key in items) {
      reportData[key] = { in: 0, out: 0 };
    }
    filteredLogs.forEach(entry => {
      if (entry.type === 'reset') return;
      if (entry.itemKey in reportData) {
        if (entry.type === 'add') reportData[entry.itemKey].in += entry.quantity;
        else if (entry.type === 'take') reportData[entry.itemKey].out += entry.quantity;
      }
    });
    let html = '';
    let totalIn = 0, totalOut = 0;
    for (const key in reportData) {
      const item = items[key];
      if (reportData[key].in > 0 || reportData[key].out > 0) {
        html += `<div class="report-summary-item">${item.name}: Added ${reportData[key].in}, Taken ${reportData[key].out}</div>`;
        totalIn += reportData[key].in;
        totalOut += reportData[key].out;
      }
    }
    if (html === '') return '<p><em>No transactions during this period.</em></p>';
    return `<div class="report-summary">Total Added: ${totalIn}</div><div class="report-summary">Total Taken: ${totalOut}</div>` + html;
  }

  function updateDailyReport() {
    const today = new Date(); today.setHours(0, 0, 0, 0);
    const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
    const logs = transactionLog.filter(e => new Date(e.timestamp) >= today && new Date(e.timestamp) < tomorrow);
    document.getElementById('dailyReport').innerHTML = getAggregatedReport(logs);
  }

  function updateWeeklyReport() {
    const today = new Date();
    const firstDayOfWeek = new Date(today.getFullYear(), today.getMonth(), today.getDate() - today.getDay());
    firstDayOfWeek.setHours(0, 0, 0, 0);
    const lastDayOfWeek = new Date(firstDayOfWeek); lastDayOfWeek.setDate(lastDayOfWeek.getDate() + 7);
    const logs = transactionLog.filter(e => new Date(e.timestamp) >= firstDayOfWeek && new Date(e.timestamp) < lastDayOfWeek);
    document.getElementById('weeklyReport').innerHTML = getAggregatedReport(logs);
  }

  function updateCurrentMonthReport() {
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 1);
    const logs = transactionLog.filter(e => new Date(e.timestamp) >= firstDay && new Date(e.timestamp) < lastDay);
    const monthName = firstDay.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
    document.getElementById('currentMonthReport').innerHTML = `
      <h4>Current Month: ${monthName}</h4>
      ${getAggregatedReport(logs)}
    `;
  }

  function updateLastMonthReport() {
    const today = new Date();
    const firstDayLastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
    const lastDayLastMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    const logs = transactionLog.filter(e => new Date(e.timestamp) >= firstDayLastMonth && new Date(e.timestamp) < lastDayLastMonth);
    const monthName = firstDayLastMonth.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
    document.getElementById('lastMonthReport').innerHTML = `
      <h4>Last Month: ${monthName}</h4>
      ${getAggregatedReport(logs)}
    `;
  }

  function generateReports() {
    updateDailyReport();
    updateWeeklyReport();
    updateCurrentMonthReport();
    updateLastMonthReport();
  }

  function exportToCsv() {
    let csvContent = "text/csv;charset=utf-8,Item,Current Stock,Total In,Total Out\n";
    for (const key in items) {
      const item = items[key];
      csvContent += `${item.name},${item.stock},${item.in},${item.out}\n`;
    }

    csvContent += "\n\nTransaction Log\n";
    csvContent += "Timestamp,Action,Item,Quantity,Person,Purpose\n";

    [...transactionLog].reverse().forEach(entry => {
      if (entry.type !== 'reset') {
        const date = new Date(entry.timestamp);
        const formattedDate = date.toLocaleString('en-GB');
        const action = entry.type === 'add' ? 'Added' : 'Taken';
        const itemName = items[entry.itemKey]?.name || entry.itemKey;
        const purpose = entry.itemKey === 'tp' && entry.purpose ? entry.purpose : '';
        csvContent += `"${formattedDate}","${action}","${itemName}",${entry.quantity},"${entry.person}","${purpose}"\n`;
      }
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "inventory_report.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function exportToPdf() {
    if (typeof window.jspdf === 'undefined') {
      alert("jsPDF not loaded. Please check internet connection.");
      return;
    }
    const { jsPDF } = window.jspdf;
    if (typeof doc.autoTable === 'undefined' && typeof jsPDF.prototype.autoTable === 'undefined') {
      alert("jsPDF AutoTable plugin not loaded.");
      return;
    }
    const doc = new jsPDF();

    const reportType = (prompt("Enter report type: 'month', 'year', or 'life' (default)") || 'life').toLowerCase();
    let filteredTransactions = [];
    let reportTitle = "Reception Stock Inventory Report (Life to Date)";
    const today = new Date(); today.setHours(0, 0, 0, 0);

    if (reportType === 'month') {
      reportTitle = "Reception Stock Inventory Report (Month to Date)";
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      filteredTransactions = transactionLog.filter(e => new Date(e.timestamp) >= firstDay && new Date(e.timestamp) <= today);
    } else if (reportType === 'year') {
      reportTitle = "Reception Stock Inventory Report (Year to Date)";
      const firstDay = new Date(today.getFullYear(), 0, 1);
      filteredTransactions = transactionLog.filter(e => new Date(e.timestamp) >= firstDay && new Date(e.timestamp) <= today);
    } else {
      filteredTransactions = transactionLog;
    }

    doc.setFontSize(18);
    doc.text(reportTitle, 10, 10);

    doc.setFontSize(14);
    doc.text("Current Stock Levels:", 10, 20);
    const stockTableData = Object.values(items).map(item => [item.name, item.stock, item.in, item.out]);
    doc.autoTable({
      startY: 30,
      head: [['Item', 'Stock', 'Total In', 'Total Out']],
      body: stockTableData,
      theme: 'grid',
      styles: { fontSize: 10 },
      columnStyles: { 0: { cellWidth: 50 }, 1: { cellWidth: 25 }, 2: { cellWidth: 30 }, 3: { cellWidth: 30 } }
    });

    const logY = doc.autoTable.previous ? doc.autoTable.previous.finalY + 10 : 60;
    doc.setFontSize(14);
    doc.text("Transaction Log:", 10, logY);
    const logTableData = [...filteredTransactions].reverse()
      .filter(e => e.type !== 'reset')
      .map(e => {
        const date = new Date(e.timestamp);
        const formatted = date.toLocaleString('en-GB');
        let desc = e.type === 'add' ? 'Added' : 'Taken';
        desc += ` ${e.quantity} of ${items[e.itemKey]?.name || e.itemKey} by ${e.person}`;
        if (e.itemKey === 'tp' && e.purpose) desc += ` for ${e.purpose}`;
        return [formatted, desc];
      });

    if (logTableData.length > 0) {
      doc.autoTable({
        startY: logY + 10,
        head: [['Timestamp', 'Description']],
        body: logTableData,
        theme: 'grid',
        styles: { fontSize: 8 },
        columnStyles: { 0: { cellWidth: 50 }, 1: { cellWidth: 'auto' } }
      });
    } else {
      doc.text("No transactions for this period.", 10, logY + 10);
    }

    doc.save(`inventory_report_${reportType}.pdf`);
  }

  // Show/hide toilet paper purpose dropdown
  function updateToiletPurposeVisibility() {
    const itemKey = document.getElementById('itemSelect').value;
    const container = document.getElementById('toiletPurposeContainer');
    container.style.display = itemKey === 'tp' ? 'block' : 'none';
  }

  // Init
  document.addEventListener('DOMContentLoaded', () => {
    loadData();

    document.getElementById('addBtn').addEventListener('click', addStock);
    document.getElementById('takeBtn').addEventListener('click', takeStock);
    document.getElementById('resetBtn').addEventListener('click', resetStats);
    document.getElementById('exportCsvBtn').addEventListener('click', exportToCsv);
    document.getElementById('exportPdfBtn').addEventListener('click', exportToPdf);
    document.getElementById('itemSelect').addEventListener('change', updateToiletPurposeVisibility);
  });
</script>
</body>
</html>

